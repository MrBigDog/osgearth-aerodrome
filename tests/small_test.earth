<!--

|  Texture splatting test.
|
|  Run with splat.bat, (or splat-edit.bat for tweakery)
-->

<map>
        
    <options>
        <terrain min_lod="20" min_normal_map_lod="9"/>
    </options>
    
    <image name="Flattener" driver="agglite" shared="true" coverage="true" visible="false">
        <features driver="ogr" url="small_test/APTBoundary_Elev_v3.shp"/>
        <styles>
            <style type="text/css">
                default {
                    coverage-value: [ELEVATION];
                }
            </style>
        </styles>
        <cache_policy usage="no_cache"/>        
        <shared_sampler>flatten_mask</shared_sampler>
        <shared_matrix>flatten_matrix</shared_matrix>
    </image>
    
    <elevation name="readymap_elevation" driver="tms" enabled="true">
        <url>http://readymap.org/readymap/tiles/1.0.0/116/</url>
    </elevation>
    
    <image name="GLOBCOVER" driver="gdal" shared="true" visible="false" coverage="true" enabled="true">
        <url>C:/data/ESA/GLOBCOVER_L4_200901_200912_V2.3_tiled.tif</url>
        <cache_policy usage="none"/>
    </image>

    <extensions>
        
        <!--
        <normalmap/>    

        <bumpmap>
            <image>../data/rock_hard.jpg</image>
            <octaves>32</octaves>
            <intensity>1.5</intensity>
        </bumpmap>
        -->
    
        <splat>
            <coverage>GLOBCOVER</coverage>
            <legend>C:/dev/git/osgearth/data/splat/GLOBCOVER_legend.xml</legend>
            <catalog>C:/dev/git/osgearth/data/splat/splat_catalog.xml</catalog>
        </splat>
            
        <viewpoints>
            <viewpoint name="KMKE" heading="12.4" lat="42.9472" long="-87.8967" height="0.0" pitch="-80" range="15000" />
            <viewpoint name="KBFI" heading="12.4" lat="47.5300" long="-122.3019" height="0.0" pitch="-80" range="15000" />
            <viewpoint name="KHEF" heading="12.4" lat="38.7214" long="-77.5156" height="0.0" pitch="-80.0" range="10000" />
            <viewpoint name="KGSO" heading="12.4" lat="36.0978" long="-79.9372" height="0.0" pitch="-80" range="15000" />
            <viewpoint name="KMMU" heading="12.4" lat="40.7994" long="-74.4150" height="0.0" pitch="-80" range="15000" />
            <viewpoint name="sshot" heading="111.0252162283699" height="9.867343158461154" lat="47.52960299910875" long="-122.3012059344189" pitch="-11.95795528996846" range="562.5549797959304"/>
            <sky driver="simple" hours="19.0"/>
        </viewpoints>
        
        <terrainshader>
            <code><![CDATA[
            
                #version 330
                #pragma vp_entryPoint "flattenTerrain"
                #pragma vp_location   "vertex_model"
                #pragma vp_order      "1.0"
                
                // encodes the upvector and the elevation
                in vec4 oe_terrain_attr;
                
                uniform float     flatten_elevation;
                uniform sampler2D flatten_mask;
                uniform mat4      flatten_matrix;
                varying vec4      oe_layer_tilec;
                
                void flattenTerrain(inout vec4 vertex)
                {
                    vec4 sample = texture(flatten_mask, (flatten_matrix*oe_layer_tilec).st);
                    
                    // decoding information.
                    const vec4  NO_DATA  = vec4(1,1,1,1);
                    const float minValue = -8192.0;
                    const float maxValue =  8192.0;                    
                    const vec4 decoderRing = vec4(1.00392156, 1.00392156/255.0, 1.00392156/(255.0*255.0), 1.00392156/(255.0*255.0*255.0));
                    
                    float hasData = sample == NO_DATA ? 0.0 : 1.0;
                    
                    float elevation = dot(sample, decoderRing);
                    elevation = minValue + elevation*(maxValue-minValue);
                    
                    vertex.xyz -= oe_terrain_attr.xyz*oe_terrain_attr.w *hasData;
                    vertex.z   += elevation *hasData;
                }
                
            ]]></code>
        </terrainshader>
            
    </extensions>

</map>
